
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Link Network Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f8f9fa; }
        .agent-card { transition: transform 0.2s; }
        .agent-card:hover { transform: translateY(-5px); }
        .status-badge { position: absolute; top: 10px; right: 10px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1"><i class="fas fa-network-wired"></i> AI Link MCP Network</span>
            <span class="navbar-text text-light" id="connection-status">Connecting...</span>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Stats Row -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card text-white bg-primary mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Active Agents</h5>
                        <p class="card-text display-4" id="stat-agents">0</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-white bg-success mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Tasks Completed</h5>
                        <p class="card-text display-4" id="stat-completed">0</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-white bg-warning text-dark mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Pending Tasks</h5>
                        <p class="card-text display-4" id="stat-pending">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Strategy & Risk Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card shadow h-100">
                    <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-shield-alt"></i> Risk Sentinel</h5>
                        <span class="badge bg-light text-dark" id="risk-status">Active</span>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-3">
                            <span>Liquidation Buffer:</span>
                            <span class="fw-bold text-success">> 10% (Safe)</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Danger Threshold:</span>
                            <span class="fw-bold text-danger">< 5.0%</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card shadow h-100">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-chess-knight"></i> Active Strategies</h5>
                    </div>
                    <div class="card-body" id="strategies-list">
                        <!-- Filled by JS -->
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- content grid -->
        <div class="row">
            <!-- Active Positions -->
            <div class="col-md-12 mb-4">
                <div class="card shadow border-primary">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-chart-line"></i> Live Positions</h5>
                        <span class="badge bg-light text-dark" id="positions-count">0</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Symbol</th>
                                        <th>Side</th>
                                        <th>Size</th>
                                        <th>Entry</th>
                                        <th>Liq. Price</th>
                                        <th>PnL</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="positions-table">
                                    <!-- Filled by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Agents List -->
            <div class="col-md-12 mb-4">
                <div class="card shadow">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="fas fa-robot"></i> Agent Registry</h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="agents-grid">
                            <!-- filled by js -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Task Queue -->
            <div class="col-md-12">
                <div class="card shadow">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-tasks"></i> Global Task Queue</h5>
                        <span class="badge bg-secondary" id="queue-count">0</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>Description</th>
                                        <th>Status</th>
                                        <th>Assigned To</th>
                                        <th>Capabilities</th>
                                        <th>Created</th>
                                    </tr>
                                </thead>
                                <tbody id="tasks-table">
                                    <!-- filled by js -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_KEY = 'ai-link-secure-key'; // Default
        const REFRESH_RATE = 2000;

        async function fetchData(endpoint) {
            try {
                const res = await fetch(endpoint, {
                    headers: { 'x-api-key': API_KEY }
                });
                if (!res.ok) throw new Error(res.statusText);
                return await res.json();
            } catch (e) {
                console.error("Fetch error:", e);
                document.getElementById('connection-status').textContent = "Offline";
                document.getElementById('connection-status').className = "navbar-text text-danger";
                return null;
            }
        }

        async function updateDashboard() {
            // --- NEW: Risk Status ---
            const riskData = await fetchData('/api/risk-status');
            if (riskData) {
                const badge = document.getElementById('risk-status');
                badge.textContent = riskData.status.toUpperCase();
                badge.className = riskData.status === 'active' ? 'badge bg-success' : 'badge bg-secondary';
            }

            // --- NEW: Strategies ---
            const stratData = await fetchData('/api/strategies');
            if (stratData) {
                const list = document.getElementById('strategies-list');
                list.innerHTML = stratData.strategies.map(s => `
                    <div class="d-flex justify-content-between align-items-center mb-2 border-bottom pb-2">
                        <div>
                            <span class="fw-bold">${s.name}</span>
                            <br><span class="small text-muted">${s.type.toUpperCase()}</span>
                        </div>
                        <span class="badge ${s.status === 'active' ? 'bg-success' : 'bg-secondary'}">${s.status}</span>
                    </div>
                `).join('');
            }

            // --- NEW: Positions ---
            const posData = await fetchData('/api/positions');
            if (posData) {
                document.getElementById('positions-count').textContent = posData.count;
                const table = document.getElementById('positions-table');
                
                if (posData.positions.length === 0) {
                    table.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No active positions</td></tr>';
                } else {
                    table.innerHTML = posData.positions.map(p => {
                        const pnlVal = parseFloat(p.pnl || 0);
                        const pnlClass = pnlVal >= 0 ? 'text-success' : 'text-danger';
                        return `
                        <tr>
                            <td class="fw-bold">${p.symbol}</td>
                            <td><span class="badge ${p.side === 'long' ? 'bg-success' : 'bg-danger'}">${p.side.toUpperCase()}</span></td>
                            <td>$${p.size} <span class="text-muted small">x${p.leverage}</span></td>
                            <td>$${(p.entryPrice||0).toFixed(2)}</td>
                            <td class="text-danger">$${(p.liquidationPrice||0).toFixed(2)}</td>
                            <td class="${pnlClass}">${p.pnl ? '$' + p.pnl.toFixed(2) : '-'}</td>
                            <td>${p.status}</td>
                        </tr>
                    `}).join('');
                }
            }

            // Agents
            const agentsData = await fetchData('/api/agents');
            if (agentsData) {
                document.getElementById('connection-status').textContent = "Online";
                document.getElementById('connection-status').className = "navbar-text text-success";
                document.getElementById('stat-agents').textContent = agentsData.count;
                
                const grid = document.getElementById('agents-grid');
                grid.innerHTML = agentsData.agents.map(ai => `
                    <div class="col-md-4 col-lg-3 mb-3">
                        <div class="card agent-card h-100 border-start border-4 border-info">
                            <div class="card-body">
                                <span class="badge bg-success status-badge">Active</span>
                                <h6 class="card-title fw-bold text-truncate">${ai.name}</h6>
                                <p class="card-subtitle text-muted small mb-2">${ai.aiId}</p>
                                <div class="mt-2">
                                    ${ai.capabilities.map(c => `<span class="badge bg-light text-dark border me-1 mb-1">${c}</span>`).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            // Tasks
            const tasksData = await fetchData('/api/tasks');
            if (tasksData) {
                const tasks = tasksData.tasks;
                const completed = tasks.filter(t => t.status === 'completed').length;
                const pending = tasks.filter(t => t.status === 'pending').length;

                document.getElementById('stat-completed').textContent = completed;
                document.getElementById('stat-pending').textContent = pending;
                document.getElementById('queue-count').textContent = tasks.length;

                const table = document.getElementById('tasks-table');
                // Show latest first
                const sortedTasks = [...tasks].sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                table.innerHTML = sortedTasks.map(t => {
                    let statusClass = 'bg-secondary';
                    if (t.status === 'pending') statusClass = 'bg-warning text-dark';
                    if (t.status === 'in-progress') statusClass = 'bg-primary';
                    if (t.status === 'completed') statusClass = 'bg-success';

                    return `
                    <tr>
                        <td class="small font-monospace text-muted">${t.taskId.substring(5, 15)}...</td>
                        <td>${t.description}</td>
                        <td><span class="badge ${statusClass}">${t.status}</span></td>
                        <td>${t.assignedTo || '<span class="text-muted">-</span>'}</td>
                        <td>${(t.requiredCapabilities||[]).join(', ')}</td>
                        <td class="small text-muted">${new Date(t.createdAt).toLocaleTimeString()}</td>
                    </tr>
                `}).join('');
            }
        }

        setInterval(updateDashboard, REFRESH_RATE);
        updateDashboard();
    </script>
</body>
</html>
